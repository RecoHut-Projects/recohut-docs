---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.13.7
  kernelspec:
    display_name: Python 3
    name: python3
---

```python colab={"base_uri": "https://localhost:8080/"} id="hAu8ogjvAjgU" executionInfo={"status": "ok", "timestamp": 1626417477926, "user_tz": -330, "elapsed": 73342, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="801f1efd-a148-485b-e127-86d4cce75855"
!wget https://staticassets.coveo.com/ai-labs/SIGIR-ecom-data-challenge.zip
```

```python id="tKfXTHf1Etu0"
%reload_ext google.colab.data_table
```

```python colab={"base_uri": "https://localhost:8080/"} id="QU71h0aUCApk" executionInfo={"status": "ok", "timestamp": 1626417657853, "user_tz": -330, "elapsed": 177508, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="438e7e7f-341a-4a09-c68b-d373981697bf"
!unzip SIGIR-ecom-data-challenge.zip
```

```python id="UzYJuvaECOQT"
import pandas as pd
```

<!-- #region id="IXhH60jtMZDX" -->
## ```browsing_train.csv```
<!-- #endregion -->

```python colab={"base_uri": "https://localhost:8080/"} id="C8jzlijuDWZi" executionInfo={"status": "ok", "timestamp": 1626417757771, "user_tz": -330, "elapsed": 859, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="711c15a5-3528-4f21-9a4f-a40db77750a8"
!head /content/train/browsing_train.csv
```

```python id="sreA5sRKDS9S"
df = pd.read_csv('/content/train/browsing_train.csv')
```

```python colab={"base_uri": "https://localhost:8080/"} id="b1hbfo0CEOzz" executionInfo={"status": "ok", "timestamp": 1626423423740, "user_tz": -330, "elapsed": 27, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="c145ea0f-539a-47ec-f519-3ba09e3f5c09"
df.info()
```

```python colab={"base_uri": "https://localhost:8080/"} id="OB9VOPXCESnU" executionInfo={"status": "ok", "timestamp": 1626418254344, "user_tz": -330, "elapsed": 39361, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="49baca54-af5c-447c-f105-9eabd72910bc"
x = df.describe(include=['O'])
```

```python colab={"base_uri": "https://localhost:8080/"} id="ePPjPcnIEb6i" executionInfo={"status": "ok", "timestamp": 1626418603299, "user_tz": -330, "elapsed": 419, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="f0aa290a-a954-4033-bfc0-069be48a15a8"
y = x.T
```

```python id="IFdrotYeFyWk"
y.loc['session_id_hash', 'description'] = "Hashed identifier of the shopping session. A session groups together events that are at most 30 minutes apart: if the same user comes back to the target website after 31 minutes from the last interaction, a new session identifier is assigned."
y.loc['event_type', 'description'] = "The type of event according to the Google Protocol, one of { pageview , event }; for example, an add event can happen on a page load, or as a stand-alone event."
y.loc['product_action', 'description'] = "One of { detail, add, purchase, remove }. If the field is empty, the event is a simple page view (e.g. the FAQ page) without associated products. Please also note that an action involving removing a product from the cart might lead to several consecutive remove events. Please note that click events (that is, events generated by clicking on a search page) are included in the search_train.csv file."
y.loc['product_sku_hash', 'description'] = "If the event is a product event, hashed identifier of the product in the event."
y.loc['session_id_hash', 'description'] = "Hashed identifier of the shopping session. A session groups together events that are at most 30 minutes apart: if the same user comes back to the target website after 31 minutes from the last interaction, a new session identifier is assigned."
y.loc['hashed_url', 'description'] = "Hashed url of the current web page."
y.loc['server_timestamp_epoch_ms	', 'description'] = "Epoch time, in milliseconds. As a further anonymization technique, the timestamp has been shifted by an unspecified amount of weeks, keeping intact the intra-week patterns."
```

```python colab={"base_uri": "https://localhost:8080/"} id="C1SxTbLAGJ1v" executionInfo={"status": "ok", "timestamp": 1626418887288, "user_tz": -330, "elapsed": 643, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="83011933-1fc4-4a9a-bcc7-0d6943984748"
y
```

```python colab={"base_uri": "https://localhost:8080/"} id="L6BzZbRZKlk9" executionInfo={"status": "ok", "timestamp": 1626419671805, "user_tz": -330, "elapsed": 9418, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="7ac161da-b83e-43d5-f2cd-72e83caabf22"
df.isnull().sum()
```

```python id="_l1ApQdPYTLv"
def encode_hash(hashlist, old_map=None):
  map = {}
  index=0
  if old_map:
    map = old_map
    index = max(old_map.values())+1
  for x in tqdm(hashlist):
    if x not in map.keys():
      map[x] = index
      index+=1
  map[np.NaN] = np.NaN
  return map

def encode_hash_list(hashlist, old_map=None):
  flat_list = [item for sublist in hashlist for item in sublist]
  map = {}
  index=0
  if old_map:
    map = old_map
    index = max(old_map.values())+1
  for x in tqdm(flat_list):
    if x not in map.keys():
      map[x] = index
      index+=1
  map["NA"] = np.NaN
  return map
```

```python id="PigRa27-cIln"
import numpy as np
```

```python colab={"base_uri": "https://localhost:8080/"} id="hWkSOLAbd88l" executionInfo={"status": "ok", "timestamp": 1626424729177, "user_tz": -330, "elapsed": 428, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="3a8de936-42bb-418e-8273-45eccb3ffea3"
df.columns
```

```python colab={"base_uri": "https://localhost:8080/"} id="rS6_Qk_XdxzS" executionInfo={"status": "ok", "timestamp": 1626424892279, "user_tz": -330, "elapsed": 79998, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="8a80fe27-5901-4e65-bd84-0d1e3ccbd550"
map_session_id_hash = encode_hash(df['session_id_hash'].tolist())
map_event_type = encode_hash(df['event_type'].tolist())
map_product_action = encode_hash(df['product_action'].tolist())
map_product_sku_hash = encode_hash(df['product_sku_hash'].tolist())
map_hashed_url = encode_hash(df['hashed_url'].tolist())
```

```python id="hbl0KKp3elAD"
df.loc[:,'session_id_hash'] = df['session_id_hash'].map(map_session_id_hash)
df.loc[:,'event_type'] = df['event_type'].map(map_event_type)
df.loc[:,'product_action'] = df['product_action'].map(map_product_action)
df.loc[:,'product_sku_hash'] = df['product_sku_hash'].map(map_product_sku_hash)
df.loc[:,'hashed_url'] = df['hashed_url'].map(map_hashed_url)
```

```python colab={"base_uri": "https://localhost:8080/"} id="20IPWqOSe2N5" executionInfo={"status": "ok", "timestamp": 1626425230464, "user_tz": -330, "elapsed": 644, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="0a95603e-44e3-4060-a477-8eef1d87a504"
df.sample(10)
```

```python id="3Ee-H0ajK4jq"
# df['product_action'] = df['product_action'].fillna('pageview')
# df['product_sku_hash'] = df['product_sku_hash'].fillna('pageview')
# df.isnull().sum()
```

```python id="O9TmRhA2IoUH"
# from sklearn.preprocessing import LabelEncoder

# encoder_session_id_hash = LabelEncoder()
# df.loc[:,'session_id_hash'] = encoder_session_id_hash.fit_transform(df['session_id_hash'])

# encoder_event_type = LabelEncoder()
# df.loc[:,'event_type'] = encoder_session_id_hash.fit_transform(df['event_type'])

# encoder_product_action = LabelEncoder()
# df.loc[:,'product_action'] = encoder_session_id_hash.fit_transform(df['product_action'])

# encoder_product_sku_hash = LabelEncoder()
# df.loc[:,'product_sku_hash'] = encoder_session_id_hash.fit_transform(df['product_sku_hash'])

# encoder_hashed_url = LabelEncoder()
# df.loc[:,'hashed_url'] = encoder_session_id_hash.fit_transform(df['hashed_url'])
```

```python id="CSC-HUgNGKdz"
df.to_parquet('browsing.parquet.gzip', compression='gzip')
```

<!-- #region id="8R0A2FSyMD3Y" -->
## ```search_train.csv```
<!-- #endregion -->

```python colab={"base_uri": "https://localhost:8080/"} id="u135IT7KMbkl" executionInfo={"status": "ok", "timestamp": 1626425508752, "user_tz": -330, "elapsed": 1390, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="eef2fa1f-2b45-4f66-aea0-254a1bf09cb3"
!head /content/train/search_train.csv
```

```python id="-dGMz6uQMbkn"
df = pd.read_csv('/content/train/search_train.csv')
```

```python colab={"base_uri": "https://localhost:8080/"} id="LPzhikiCMbkn" executionInfo={"status": "ok", "timestamp": 1626425566222, "user_tz": -330, "elapsed": 24, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="ea1d262f-89ae-4008-e07a-07056ba2e212"
df.info()
```

```python colab={"base_uri": "https://localhost:8080/", "height": 381} id="VyOPOTGhMbko" executionInfo={"status": "ok", "timestamp": 1626425569221, "user_tz": -330, "elapsed": 3015, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="ed1bcefd-7c1b-4137-98c1-9eafa4f7a74b"
y = df.describe(include=['O']).T
y
```

```python id="N5UT9d83Mbkq"
y.loc['session_id_hash', 'description'] = "Hashed identifier of the shopping session. A session groups together events that are at most 30 minutes apart: if the same user comes back to the target website after 31 minutes from the last interaction, a new session identifier is assigned."
y.loc['query_vector', 'description'] = "A dense representation of the search query, obtained through standard pre-trained modeling and dimensionality reduction techniques. Please note that this representation is compatible with the one in the catalog file."
y.loc['product_skus_hash', 'description'] = "Hashed identifiers of the products in the search response."
y.loc['clicked_skus_hash', 'description'] = "Hashed identifiers of the products clicked after issuing the search query."
y.loc['server_timestamp_epoch_ms', 'description'] = "Epoch time, in milliseconds. As a further anonymization technique, the timestamp has been shifted by an unspecified amount of weeks, keeping intact the intra-week patterns."
```

```python colab={"base_uri": "https://localhost:8080/", "height": 1154} id="RT8lM2LkMbkr" executionInfo={"status": "ok", "timestamp": 1626425569226, "user_tz": -330, "elapsed": 24, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="df93e00e-5a74-49c2-bab3-d35666aadc4d"
y
```

```python colab={"base_uri": "https://localhost:8080/"} id="E2y3b7udMbks" executionInfo={"status": "ok", "timestamp": 1626425569662, "user_tz": -330, "elapsed": 5, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="b12e79e9-c0f6-48cd-f13a-d8fcb90975c3"
df.isnull().sum()
```

```python id="WZnDMMfjXFwb"
from tqdm import tqdm
```

```python id="U83Pa8D7W1zO"
# map_session_id_hash = encode_hash(df['session_id_hash'].tolist())
# map_event_type = encode_hash(df['event_type'].tolist())
# map_product_action = encode_hash(df['product_action'].tolist())
# map_product_sku_hash = encode_hash(df['product_sku_hash'].tolist())
# map_hashed_url = encode_hash(df['hashed_url'].tolist())
```

```python id="cVCoD60jpuOv"
df['clicked_skus_hash'] = df['clicked_skus_hash'].fillna("['NA']")
hashlist_clicked_skus_hash = [ast.literal_eval(x) for x in df['clicked_skus_hash'].tolist()]

df['product_skus_hash'] = df['product_skus_hash'].fillna("['NA']")
hashlist_product_skus_hash = [ast.literal_eval(x) for x in df['product_skus_hash'].tolist()]
```

```python colab={"base_uri": "https://localhost:8080/"} id="LkLb4GPCzDDM" executionInfo={"status": "ok", "timestamp": 1626430435548, "user_tz": -330, "elapsed": 12044, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="3a2db347-7d76-47e4-8f74-76bfc3db68ea"
map_session_id_hash = encode_hash(df.session_id_hash.tolist(), old_map=map_session_id_hash)
map_product_sku_hash = encode_hash_list(hashlist_clicked_skus_hash, old_map=map_product_sku_hash)
map_product_sku_hash = encode_hash_list(hashlist_product_skus_hash, old_map=map_product_sku_hash)
```

```python id="wiQxcyWyuwR4"
df.loc[:, 'session_id_hash'] = df['session_id_hash'].map(map_session_id_hash)
df.loc[:, 'clicked_skus_hash'] = df['clicked_skus_hash'].apply(lambda x: [map_product_sku_hash[y] for y in ast.literal_eval(x)])
df.loc[:, 'product_skus_hash'] = df['product_skus_hash'].apply(lambda x: [map_product_sku_hash[y] for y in ast.literal_eval(x)])
```

```python colab={"base_uri": "https://localhost:8080/", "height": 529} id="2bBueF1NMbku" executionInfo={"status": "ok", "timestamp": 1626430642325, "user_tz": -330, "elapsed": 24, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="a5376bf4-aa87-4c63-922f-7681e7479b0b"
df.sample(10)
```

```python id="Kz3eBNgaMbkv"
df.to_parquet('search.parquet.gzip', compression='gzip')
```

<!-- #region id="HwMFEIN81MzA" -->
## ```sku_to_content.csv```

<!-- #endregion -->

```python colab={"base_uri": "https://localhost:8080/"} id="jpcVLsvR1MzB" executionInfo={"status": "ok", "timestamp": 1626430860253, "user_tz": -330, "elapsed": 970, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="75fce10b-2c9e-4531-9f0a-8322f2b6024f"
!head /content/train/sku_to_content.csv
```

```python id="HSz4sqCp1MzD"
df = pd.read_csv('/content/train/sku_to_content.csv')
```

```python colab={"base_uri": "https://localhost:8080/", "height": 2563} id="y1NigpcP2sye" executionInfo={"status": "ok", "timestamp": 1626431217748, "user_tz": -330, "elapsed": 950, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="17df4b27-a613-4dc0-bada-642b50ab1d60"
df.head()
```

```python colab={"base_uri": "https://localhost:8080/"} id="4tqb0VGp1MzD" executionInfo={"status": "ok", "timestamp": 1626430869961, "user_tz": -330, "elapsed": 20, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="9a492bb1-64e2-4e3b-8f8e-27d2a67fe260"
df.info()
```

```python colab={"base_uri": "https://localhost:8080/", "height": 173} id="xqzoUdUK1MzE" executionInfo={"status": "ok", "timestamp": 1626430876733, "user_tz": -330, "elapsed": 688, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="e443d24a-3b61-4c2e-b31c-f2cee698b28f"
y = df.describe(include=['O']).T
y
```

```python colab={"base_uri": "https://localhost:8080/"} id="rTbDet9q1sBH" executionInfo={"status": "ok", "timestamp": 1626430952310, "user_tz": -330, "elapsed": 730, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="57b5d72a-bf36-4382-c977-6ee98d18e5ef"
df.columns
```

```python id="53aETeEa1MzF"
y.loc['product_sku_hash', 'description'] = "Hashed identifier of product ID (SKU)."
y.loc['description_vector', 'description'] = "The categories are hashed representations of the category hierarchy, /-separated."
y.loc['category_hash', 'description'] = "The product price, provided as a 10-quantile integer."
y.loc['image_vector', 'description'] = "A dense representation of textual meta-data, obtained through standard pre-trained modeling and dimensionality reduction techniques. Please note that this representation is compatible with the one in the search file."
y.loc['price_bucket', 'description'] = "A dense representation of image meta-data, obtained through standard pre-trained modeling and dimensionality reduction techniques."
```

```python colab={"base_uri": "https://localhost:8080/", "height": 819} id="BA5-jPQO1MzG" executionInfo={"status": "ok", "timestamp": 1626431072652, "user_tz": -330, "elapsed": 646, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="acd4a91c-026f-4c09-95a9-562460b13488"
y
```

```python colab={"base_uri": "https://localhost:8080/"} id="AHwjLsUT1MzH" executionInfo={"status": "ok", "timestamp": 1626431167063, "user_tz": -330, "elapsed": 590, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="06957e33-9356-498b-cad3-4b3816c1a136"
df.isnull().sum()
```

```python id="yMcyMCfG1MzI"
from tqdm import tqdm
```

```python id="6jliqDtW1MzI"
# map_session_id_hash = encode_hash(df['session_id_hash'].tolist())
# map_event_type = encode_hash(df['event_type'].tolist())
# map_product_action = encode_hash(df['product_action'].tolist())
# map_product_sku_hash = encode_hash(df['product_sku_hash'].tolist())
# map_hashed_url = encode_hash(df['hashed_url'].tolist())
```

```python colab={"base_uri": "https://localhost:8080/"} id="pXecKDy71MzK" executionInfo={"status": "ok", "timestamp": 1626431395089, "user_tz": -330, "elapsed": 519, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="0c6e42ee-5683-4e7e-8fb4-b3535717b7a9"
map_product_sku_hash = encode_hash(df.product_sku_hash.tolist(), old_map=map_product_sku_hash)
map_category_hash = encode_hash(df.category_hash.tolist())
```

```python id="rNopiyEH1MzK"
df.loc[:, 'product_sku_hash'] = df['product_sku_hash'].map(map_product_sku_hash)
df.loc[:, 'category_hash'] = df['category_hash'].map(map_category_hash)
```

```python colab={"base_uri": "https://localhost:8080/", "height": 4523} id="kNr4tp381MzL" executionInfo={"status": "ok", "timestamp": 1626431431470, "user_tz": -330, "elapsed": 36, "user": {"displayName": "Sparsh Agarwal", "photoUrl": "", "userId": "13037694610922482904"}} outputId="c69e8323-8818-4533-9d2f-34b401897399"
df.sample(10)
```

```python id="2PNat_E61MzL"
df.to_parquet('metadata.parquet.gzip', compression='gzip')
```

<!-- #region id="-868wjkJ3p3p" -->
## Label encoder maps
<!-- #endregion -->

```python id="0qV8KGrU3tBU"
label_encoders = {}
label_encoders['session_id_hash'] = map_session_id_hash
label_encoders['event_type'] = map_event_type
label_encoders['product_action'] = map_product_action
label_encoders['product_sku_hash'] = map_product_sku_hash
label_encoders['hashed_url'] = map_hashed_url
label_encoders['category_hash'] = map_category_hash

import pickle
with open('label_encoders.pickle', 'wb') as handle:
  pickle.dump(label_encoders, handle, protocol=pickle.HIGHEST_PROTOCOL)
```
