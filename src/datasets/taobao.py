# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/datasets/datasets.taobao.ipynb (unless otherwise specified).

__all__ = ['TaobaoDataset', 'TaobaoDataModule']

# Cell
from .bases.ctr import *
from ..utils.common_utils import download_url

from datetime import date

# Cell
class TaobaoDataset(CTRDataset):

    feature_cols = [{'name': ["userid","adgroup_id","pid","cate_id","campaign_id","customer","brand","cms_segid",
                                "cms_group_id","final_gender_code","age_level","pvalue_level","shopping_level","occupation"],
                        'active': True, 'dtype': 'str', 'type': 'categorical'}]

    label_col = {'name': 'clk', 'dtype': float}

    train_url = "https://github.com/RecoHut-Datasets/sample_ctr/raw/v1/train_sample.csv"
    valid_url = "https://github.com/RecoHut-Datasets/sample_ctr/raw/v1/valid_sample.csv"
    test_url = "https://github.com/RecoHut-Datasets/sample_ctr/raw/v1/test_sample.csv"

    @property
    def raw_file_names(self):
        return ['train_sample.csv',
                'valid_sample.csv',
                'test_sample.csv']

    def download(self):
        download_url(self.train_url, self.raw_dir)
        download_url(self.valid_url, self.raw_dir)
        download_url(self.test_url, self.raw_dir)

    def convert_hour(self, df, col_name):
        return df['time_stamp'].apply(lambda ts: ts[11:13])

    def convert_weekday(self, df, col_name):
        def _convert_weekday(timestamp):
            dt = date(int(timestamp[0:4]), int(timestamp[5:7]), int(timestamp[8:10]))
            return dt.strftime('%w')
        return df['time_stamp'].apply(_convert_weekday)

    def convert_weekend(self, df, col_name):
        def _convert_weekend(timestamp):
            dt = date(int(timestamp[0:4]), int(timestamp[5:7]), int(timestamp[8:10]))
            return '1' if dt.strftime('%w') in ['6', '0'] else '0'
        return df['time_stamp'].apply(_convert_weekend)

# Cell
class TaobaoDataModule(CTRDataModule):
    dataset_cls = TaobaoDataset